<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fastly Cache Explainer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1a1f36 0%, #0f1419 100%);
            color: #e4e7eb;
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 0.5rem;
        }

        .fastly-logo {
            color: #FF282D;
            font-weight: 800;
        }

        .subtitle {
            color: #9ca3af;
            font-size: 1.1rem;
        }

        .input-section {
            background: #1f2937;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .input-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #fff;
            font-size: 1.1rem;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 1rem;
            background: #0f1419;
            border: 2px solid #374151;
            border-radius: 8px;
            color: #e4e7eb;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #FF282D;
        }

        textarea::placeholder {
            color: #6b7280;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FF282D 0%, #d91e23 100%);
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 40, 45, 0.4);
        }

        .btn-secondary {
            background: #374151;
            color: #e4e7eb;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .results {
            display: none;
        }

        .results.active {
            display: block;
        }

        .section-card {
            background: #1f2937;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #FF282D;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 1.3rem;
            background: #FF282D;
            border-radius: 2px;
        }

        .info-grid {
            display: grid;
            gap: 1rem;
        }

        .info-item {
            background: #0f1419;
            padding: 1rem;
            border-radius: 8px;
            border-left: 3px solid #374151;
        }

        .info-item.highlight {
            border-left-color: #FF282D;
        }

        .info-label {
            font-weight: 600;
            color: #9ca3af;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .info-value {
            color: #fff;
            font-size: 1.1rem;
            word-break: break-all;
        }

        .cache-path-item {
            background: #0f1419;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            border-left: 3px solid #374151;
        }

        .cache-path-item:last-child {
            margin-bottom: 0;
        }

        .path-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .pop-name {
            font-weight: 700;
            color: #fff;
            font-size: 1.1rem;
        }

        .path-details {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            font-size: 0.9rem;
        }

        .path-detail {
            color: #9ca3af;
        }

        .path-detail strong {
            color: #fff;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-hit {
            background: #10b981;
            color: #fff;
        }

        .badge-miss {
            background: #f59e0b;
            color: #fff;
        }

        .badge-pass {
            background: #6b7280;
            color: #fff;
        }

        .timer-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .warning {
            background: #7c2d12;
            border-left: 3px solid #f59e0b;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            color: #fed7aa;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }

            h1 {
                font-size: 2rem;
            }

            .input-section, .section-card {
                padding: 1rem;
            }

            .button-group {
                flex-direction: column;
            }

            .path-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><span class="fastly-logo">Fastly</span> Cache Explainer</h1>
            <p class="subtitle">Decode your cache debug headers into human-readable insights</p>
        </header>

        <div class="input-section">
            <label class="input-label" for="headers-input">
                Paste Your HTTP Headers
            </label>
            <textarea 
                id="headers-input" 
                placeholder="Paste headers here, for example:
fastly-debug-path: (D cache-wsi-ysbk1060028-WSI 1766557562) (F cache-wsi-ysbk1060026-WSI 1766557562)
fastly-debug-ttl: (M cache-wsi-ysbk1060028-WSI - - 0)
fastly-debug-digest: 0ef3f418d8a4af55b6ad580ce0142a91c4be772dd5ca67ad116d62387357bf1e
x-served-by: cache-mel11239-MEL
x-cache: MISS
x-cache-hits: 0
x-timer: S1766557562.572454,VS0,VE44"></textarea>
            <div class="button-group">
                <button class="btn-primary" onclick="analyzeHeaders()">Analyze Headers</button>
                <button class="btn-secondary" onclick="clearAll()">Clear</button>
            </div>
        </div>

        <div class="results" id="results">
            <!-- Results will be dynamically inserted here -->
        </div>
    </div>

    <script>
        function parseHeaders(headerText) {
            const lines = headerText.split('\n');
            const headers = {};
            
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                
                // Remove leading < or > if present (from curl -v output)
                line = line.replace(/^[<>]\s*/, '');
                
                const colonIndex = line.indexOf(':');
                if (colonIndex > -1) {
                    const key = line.substring(0, colonIndex).trim().toLowerCase();
                    const value = line.substring(colonIndex + 1).trim();
                    headers[key] = value;
                }
            });
            
            return headers;
        }

        function parseFastlyDebugPath(pathHeader) {
            if (!pathHeader) return [];
            
            // Match patterns like (D cache-location timestamp)
            const regex = /\(([A-Z])\s+([^\s]+)\s+(\d+)\)/g;
            const paths = [];
            let match;
            
            while ((match = regex.exec(pathHeader)) !== null) {
                paths.push({
                    type: match[1],
                    location: match[2],
                    timestamp: match[3]
                });
            }
            
            return paths;
        }

        function parseFastlyDebugTTL(ttlHeader) {
            if (!ttlHeader) return [];
            
            // Match patterns like (M cache-location - - 0)
            const regex = /\(([A-Z])\s+([^\s]+)\s+[^\s]+\s+[^\s]+\s+(\d+)\)/g;
            const ttls = [];
            let match;
            
            while ((match = regex.exec(ttlHeader)) !== null) {
                ttls.push({
                    type: match[1],
                    location: match[2],
                    ttl: match[3]
                });
            }
            
            return ttls;
        }

        function parseXTimer(timerHeader) {
            if (!timerHeader) return null;
            
            // Format: S1766557562.572454,VS0,VE44
            const parts = timerHeader.split(',');
            const result = {};
            
            parts.forEach(part => {
                if (part.startsWith('S')) {
                    result.startTime = part.substring(1);
                } else if (part.startsWith('VS')) {
                    result.vclStart = part.substring(2);
                } else if (part.startsWith('VE')) {
                    result.vclEnd = part.substring(2);
                }
            });
            
            return result;
        }

        function getCacheBadge(status) {
            status = status.toUpperCase();
            if (status === 'HIT') return `<span class="badge badge-hit">HIT</span>`;
            if (status === 'MISS') return `<span class="badge badge-miss">MISS</span>`;
            if (status === 'PASS') return `<span class="badge badge-pass">PASS</span>`;
            return `<span class="badge badge-pass">${status}</span>`;
        }

        function getTypeDescription(type) {
            const types = {
                'D': 'Cache Decision',
                'F': 'Fetch/Forward',
                'M': 'Miss',
                'H': 'Hit',
                'P': 'Pass'
            };
            return types[type] || type;
        }

        function analyzeHeaders() {
            const input = document.getElementById('headers-input').value;
            if (!input.trim()) {
                alert('Please paste some headers first!');
                return;
            }

            const headers = parseHeaders(input);
            const debugPath = parseFastlyDebugPath(headers['fastly-debug-path']);
            const debugTTL = parseFastlyDebugTTL(headers['fastly-debug-ttl']);
            const timer = parseXTimer(headers['x-timer']);
            
            let html = '';

            // Cache Path Analysis
            if (debugPath.length > 0) {
                html += `
                    <div class="section-card">
                        <h2 class="section-title">Cache Path Journey</h2>
                        <div class="info-grid">
                `;
                
                debugPath.forEach((path, index) => {
                    const ttlInfo = debugTTL.find(t => t.location === path.location);
                    const date = new Date(parseInt(path.timestamp) * 1000);
                    
                    html += `
                        <div class="cache-path-item">
                            <div class="path-header">
                                <span class="pop-name">üåê ${path.location}</span>
                                <span>${getCacheBadge(getTypeDescription(path.type))}</span>
                            </div>
                            <div class="path-details">
                                <div class="path-detail"><strong>Type:</strong> ${getTypeDescription(path.type)}</div>
                                <div class="path-detail"><strong>Timestamp:</strong> ${date.toISOString()}</div>
                                ${ttlInfo ? `<div class="path-detail"><strong>TTL:</strong> ${ttlInfo.ttl}s</div>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            }

            // Cache Status Summary
            if (headers['x-cache'] || headers['x-served-by'] || headers['x-cache-hits']) {
                html += `
                    <div class="section-card">
                        <h2 class="section-title">Cache Status Summary</h2>
                        <div class="info-grid">
                `;
                
                if (headers['x-cache']) {
                    const statuses = headers['x-cache'].split(',').map(s => s.trim());
                    html += `
                        <div class="info-item highlight">
                            <div class="info-label">Cache Status</div>
                            <div class="info-value">
                                ${statuses.map(s => getCacheBadge(s)).join(' ‚Üí ')}
                            </div>
                        </div>
                    `;
                }
                
                if (headers['x-served-by']) {
                    html += `
                        <div class="info-item">
                            <div class="info-label">Served By (POPs)</div>
                            <div class="info-value">${headers['x-served-by']}</div>
                        </div>
                    `;
                }
                
                if (headers['x-cache-hits']) {
                    html += `
                        <div class="info-item">
                            <div class="info-label">Cache Hits</div>
                            <div class="info-value">${headers['x-cache-hits']}</div>
                        </div>
                    `;
                }
                
                html += `</div></div>`;
            }

            // Cache Key Digest
            if (headers['fastly-debug-digest']) {
                html += `
                    <div class="section-card">
                        <h2 class="section-title">Cache Key Information</h2>
                        <div class="info-item">
                            <div class="info-label">Cache Key Digest (SHA-256)</div>
                            <div class="info-value" style="font-family: 'Courier New', monospace; font-size: 0.9rem;">
                                ${headers['fastly-debug-digest']}
                            </div>
                        </div>
                        <div class="warning">
                            <strong>‚ÑπÔ∏è Note:</strong> This digest uniquely identifies the cache key used for this request. 
                            Identical digests indicate the same cache key.
                        </div>
                    </div>
                `;
            }

            // Timing Information
            if (timer) {
                const vclTime = timer.vclEnd && timer.vclStart ? 
                    (parseInt(timer.vclEnd) - parseInt(timer.vclStart)) : null;
                
                html += `
                    <div class="section-card">
                        <h2 class="section-title">Timing Analysis</h2>
                        <div class="timer-breakdown">
                            ${timer.startTime ? `
                                <div class="info-item">
                                    <div class="info-label">Start Time</div>
                                    <div class="info-value">${timer.startTime}s</div>
                                </div>
                            ` : ''}
                            ${timer.vclStart ? `
                                <div class="info-item">
                                    <div class="info-label">VCL Start</div>
                                    <div class="info-value">${timer.vclStart}ms</div>
                                </div>
                            ` : ''}
                            ${timer.vclEnd ? `
                                <div class="info-item">
                                    <div class="info-label">VCL End</div>
                                    <div class="info-value">${timer.vclEnd}ms</div>
                                </div>
                            ` : ''}
                            ${vclTime !== null ? `
                                <div class="info-item highlight">
                                    <div class="info-label">VCL Processing Time</div>
                                    <div class="info-value">${vclTime}ms</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            if (!html) {
                html = `
                    <div class="section-card">
                        <div class="warning">
                            <strong>‚ö†Ô∏è No debug headers found!</strong><br>
                            Make sure your headers include fastly-debug-* headers. 
                            These need to be enabled in your Fastly service configuration.
                        </div>
                    </div>
                `;
            }

            document.getElementById('results').innerHTML = html;
            document.getElementById('results').classList.add('active');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function clearAll() {
            document.getElementById('headers-input').value = '';
            document.getElementById('results').classList.remove('active');
            document.getElementById('results').innerHTML = '';
        }

        // Allow Enter key to analyze (Ctrl+Enter or Cmd+Enter)
        document.getElementById('headers-input').addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                analyzeHeaders();
            }
        });
    </script>
</body>
</html>